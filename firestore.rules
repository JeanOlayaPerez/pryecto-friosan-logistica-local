rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function userData() {
      return request.auth != null
        ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data
        : null;
    }

    function userRole() {
      let data = userData();
      let raw = data == null
        ? null
        : (data.role != null ? data.role :
          data.Role != null ? data.Role :
          data.rol != null ? data.rol :
          data.Rol != null ? data.Rol :
          null);
      return raw == null ? null : lower(raw);
    }

    function hasRole(list) {
      return request.auth != null && userRole() != null && userRole() in list;
    }

    match /trucks/{truckId} {
      allow read: if request.auth != null;
      // Porteria crea, Recepcion actualiza estados, Admin todo.
      allow create: if hasRole(['porteria', 'admin']);
      allow update: if hasRole(['recepcion', 'comercial', 'admin']);
      allow delete: if hasRole(['admin', 'recepcion']);
    }

    match /users/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if false;
    }
  }
}
